{"version":3,"file":"credit-card.es.mjs","sources":["../../../src/components/credit-card/credit-card.tsx"],"sourcesContent":["// Dependencies\r\nimport * as React from 'react';\r\nimport type * as Square from '@square/web-sdk';\r\nimport type { JSX } from 'react';\r\n\r\n// Internals\r\nimport { useForm } from '~/contexts/form';\r\nimport { useEventListener } from '~/hooks/use-event-listener';\r\nimport { LoadingCard, PayButton } from './credit-card.styles';\r\nimport type {\r\n  CreditCardBase,\r\n  CreditCardChildren,\r\n  CreditCardFunctionChildren,\r\n  CreditCardPayButtonProps,\r\n  CreditCardProps,\r\n} from './credit-card.types';\r\n\r\n/**\r\n * Renders a Credit Card Input to use in the Square Web Payment SDK, pre-styled\r\n * to meet Square branding guidelines.\r\n *\r\n * **_But with the option to override styles_**\r\n *\r\n * @example\r\n *\r\n * ```tsx\r\n * function App() {\r\n *   return (\r\n *     <SquareForm {...props}>\r\n *       <CreditCard />\r\n *     </SquareForm>\r\n *   );\r\n * }\r\n * ```\r\n */\r\nfunction CreditCard(props: CreditCardBase): JSX.Element;\r\nfunction CreditCard(props: CreditCardChildren): JSX.Element;\r\nfunction CreditCard(props: CreditCardFunctionChildren): JSX.Element;\r\nfunction CreditCard({\r\n  buttonProps,\r\n  callbacks,\r\n  children,\r\n  focus,\r\n  id = 'rswps-card-container',\r\n  includeInputLabels,\r\n  postalCode,\r\n  recalculateSize,\r\n  render,\r\n  style,\r\n  ...props\r\n}: CreditCardProps) {\r\n  const [card, setCard] = React.useState<Square.Card | undefined>(() => undefined);\r\n  const [isSubmitting, setIsSubmitting] = React.useState<boolean>(false);\r\n  const buttonRef = React.useRef<HTMLButtonElement>(null);\r\n  const { cardTokenizeResponseReceived, payments } = useForm();\r\n\r\n  const options: Square.CardOptions = React.useMemo(() => {\r\n    const baseOptions = {\r\n      includeInputLabels,\r\n      postalCode,\r\n      style,\r\n    };\r\n\r\n    // if a value from options is undefined delete it from the options object\r\n    return Object.keys(baseOptions).reduce((acc: Record<string, unknown>, key) => {\r\n      if (baseOptions[key as keyof typeof baseOptions] !== undefined) {\r\n        acc[key as string] = baseOptions[key as keyof typeof baseOptions];\r\n      }\r\n\r\n      return acc;\r\n    }, {});\r\n  }, [includeInputLabels, postalCode, style]);\r\n\r\n  /**\r\n   * Handle the on click of the Credit Card button click\r\n   *\r\n   * @param e An event which takes place in the DOM.\r\n   * @returns The data be sended to `cardTokenizeResponseReceived()` function, or an error\r\n   */\r\n  const handlePayment = async (e: Event) => {\r\n    e.stopPropagation();\r\n\r\n    if (buttonProps?.isLoading) return;\r\n\r\n    if (!card) {\r\n      console.warn('Credit Card button was clicked, but no Credit Card instance was found.');\r\n\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n\r\n    try {\r\n      const result = await card.tokenize();\r\n\r\n      if (result.status === 'OK') {\r\n        const tokenizedResult = await cardTokenizeResponseReceived(result);\r\n        return tokenizedResult;\r\n      }\r\n\r\n      let message = `Tokenization failed with status: ${result.status}`;\r\n      if (result?.errors) {\r\n        message += ` and errors: ${JSON.stringify(result?.errors)}`;\r\n\r\n        throw new Error(message);\r\n      }\r\n\r\n      console.warn(message);\r\n    } catch (error) {\r\n      console.error(error);\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  React.useEffect(() => {\r\n    const abortController = new AbortController();\r\n    const { signal } = abortController;\r\n\r\n    const start = async (signal: AbortSignal) => {\r\n      const card = await payments?.card(options).then((res) => {\r\n        if (!signal.aborted) {\r\n          setCard(res);\r\n          return res;\r\n        }\r\n\r\n        return null;\r\n      });\r\n\r\n      await card?.attach(`#${id}`);\r\n      if (focus) {\r\n        await card?.focus(focus);\r\n      }\r\n\r\n      if (signal.aborted) {\r\n        await card?.destroy();\r\n      }\r\n    };\r\n\r\n    start(signal);\r\n\r\n    return () => {\r\n      abortController.abort();\r\n    };\r\n  }, [payments, id]);\r\n\r\n  React.useEffect(() => {\r\n    if (card && focus) {\r\n      card.focus(focus);\r\n    }\r\n  }, [card, focus]);\r\n\r\n  if (callbacks) {\r\n    for (const callback of Object.keys(callbacks)) {\r\n      card?.addEventListener(\r\n        callback as Square.CardInputEventTypes,\r\n        (callbacks as Record<string, (event: Square.SqEvent<Square.CardInputEvent>) => void>)[callback]\r\n      );\r\n    }\r\n  }\r\n\r\n  if (recalculateSize) {\r\n    recalculateSize(card?.recalculateSize);\r\n  }\r\n\r\n  useEventListener({\r\n    listener: handlePayment,\r\n    type: 'click',\r\n    element: buttonRef as React.RefObject<Element>,\r\n    options: {\r\n      passive: true,\r\n    },\r\n  });\r\n\r\n  const Button = ({ children, isLoading, ...props }: CreditCardPayButtonProps) => {\r\n    const id = 'rswp-card-button';\r\n    const disabled = isLoading || !card || isSubmitting;\r\n\r\n    return (\r\n      <PayButton\r\n        {...props}\r\n        aria-disabled={disabled}\r\n        css={props?.css}\r\n        disabled={disabled}\r\n        id={id}\r\n        ref={buttonRef}\r\n        type=\"button\"\r\n      >\r\n        {children ?? 'Pay'}\r\n      </PayButton>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <div {...props} data-testid=\"rswps-card-container\" id={id} style={{ minHeight: 89 }}>\r\n        {!card && <LoadingCard />}\r\n      </div>\r\n\r\n      {typeof render === 'function' ? render(Button) : <Button {...buttonProps}>{children ?? 'Pay'}</Button>}\r\n    </>\r\n  );\r\n}\r\n\r\nexport default CreditCard;\r\nexport * from './credit-card.types';\r\n"],"names":["CreditCard","buttonProps","callbacks","children","focus","id","includeInputLabels","postalCode","recalculateSize","render","style","props","card","setCard","React","isSubmitting","setIsSubmitting","buttonRef","cardTokenizeResponseReceived","payments","useForm","options","baseOptions","acc","key","handlePayment","result","message","error","abortController","signal","res","callback","useEventListener","Button","isLoading","disabled","PayButton","LoadingCard"],"mappings":"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"}