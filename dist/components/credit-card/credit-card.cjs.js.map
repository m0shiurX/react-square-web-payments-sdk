{"version":3,"file":"credit-card.cjs.js","sources":["../../../src/components/credit-card/credit-card.tsx"],"sourcesContent":["// Dependencies\r\nimport * as React from 'react';\r\nimport type * as Square from '@square/web-sdk';\r\nimport type { JSX } from 'react';\r\n\r\n// Internals\r\nimport { useForm } from '~/contexts/form';\r\nimport { useEventListener } from '~/hooks/use-event-listener';\r\nimport { LoadingCard, PayButton } from './credit-card.styles';\r\nimport type {\r\n  CreditCardBase,\r\n  CreditCardChildren,\r\n  CreditCardFunctionChildren,\r\n  CreditCardPayButtonProps,\r\n  CreditCardProps,\r\n} from './credit-card.types';\r\n\r\n/**\r\n * Renders a Credit Card Input to use in the Square Web Payment SDK, pre-styled\r\n * to meet Square branding guidelines.\r\n *\r\n * **_But with the option to override styles_**\r\n *\r\n * @example\r\n *\r\n * ```tsx\r\n * function App() {\r\n *   return (\r\n *     <SquareForm {...props}>\r\n *       <CreditCard />\r\n *     </SquareForm>\r\n *   );\r\n * }\r\n * ```\r\n */\r\nfunction CreditCard(props: CreditCardBase): JSX.Element;\r\nfunction CreditCard(props: CreditCardChildren): JSX.Element;\r\nfunction CreditCard(props: CreditCardFunctionChildren): JSX.Element;\r\nfunction CreditCard({\r\n  buttonProps,\r\n  callbacks,\r\n  children,\r\n  focus,\r\n  id = 'rswps-card-container',\r\n  includeInputLabels,\r\n  postalCode,\r\n  recalculateSize,\r\n  render,\r\n  style,\r\n  ...props\r\n}: CreditCardProps) {\r\n  const [card, setCard] = React.useState<Square.Card | undefined>(() => undefined);\r\n  const [isSubmitting, setIsSubmitting] = React.useState<boolean>(false);\r\n  const buttonRef = React.useRef<HTMLButtonElement>(null);\r\n  const { cardTokenizeResponseReceived, payments } = useForm();\r\n\r\n  const options: Square.CardOptions = React.useMemo(() => {\r\n    const baseOptions = {\r\n      includeInputLabels,\r\n      postalCode,\r\n      style,\r\n    };\r\n\r\n    // if a value from options is undefined delete it from the options object\r\n    return Object.keys(baseOptions).reduce((acc: Record<string, unknown>, key) => {\r\n      if (baseOptions[key as keyof typeof baseOptions] !== undefined) {\r\n        acc[key as string] = baseOptions[key as keyof typeof baseOptions];\r\n      }\r\n\r\n      return acc;\r\n    }, {});\r\n  }, [includeInputLabels, postalCode, style]);\r\n\r\n  /**\r\n   * Handle the on click of the Credit Card button click\r\n   *\r\n   * @param e An event which takes place in the DOM.\r\n   * @returns The data be sended to `cardTokenizeResponseReceived()` function, or an error\r\n   */\r\n  const handlePayment = async (e: Event) => {\r\n    e.stopPropagation();\r\n\r\n    if (buttonProps?.isLoading) return;\r\n\r\n    if (!card) {\r\n      console.warn('Credit Card button was clicked, but no Credit Card instance was found.');\r\n\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n\r\n    try {\r\n      const result = await card.tokenize();\r\n\r\n      if (result.status === 'OK') {\r\n        const tokenizedResult = await cardTokenizeResponseReceived(result);\r\n        return tokenizedResult;\r\n      }\r\n\r\n      let message = `Tokenization failed with status: ${result.status}`;\r\n      if (result?.errors) {\r\n        message += ` and errors: ${JSON.stringify(result?.errors)}`;\r\n\r\n        throw new Error(message);\r\n      }\r\n\r\n      console.warn(message);\r\n    } catch (error) {\r\n      console.error(error);\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  React.useEffect(() => {\r\n    const abortController = new AbortController();\r\n    const { signal } = abortController;\r\n\r\n    const start = async (signal: AbortSignal) => {\r\n      const card = await payments?.card(options).then((res) => {\r\n        if (!signal.aborted) {\r\n          setCard(res);\r\n          return res;\r\n        }\r\n\r\n        return null;\r\n      });\r\n\r\n      await card?.attach(`#${id}`);\r\n      if (focus) {\r\n        await card?.focus(focus);\r\n      }\r\n\r\n      if (signal.aborted) {\r\n        await card?.destroy();\r\n      }\r\n    };\r\n\r\n    start(signal);\r\n\r\n    return () => {\r\n      abortController.abort();\r\n    };\r\n  }, [payments, id]);\r\n\r\n  React.useEffect(() => {\r\n    if (card && focus) {\r\n      card.focus(focus);\r\n    }\r\n  }, [card, focus]);\r\n\r\n  if (callbacks) {\r\n    for (const callback of Object.keys(callbacks)) {\r\n      card?.addEventListener(\r\n        callback as Square.CardInputEventTypes,\r\n        (callbacks as Record<string, (event: Square.SqEvent<Square.CardInputEvent>) => void>)[callback]\r\n      );\r\n    }\r\n  }\r\n\r\n  if (recalculateSize) {\r\n    recalculateSize(card?.recalculateSize);\r\n  }\r\n\r\n  useEventListener({\r\n    listener: handlePayment,\r\n    type: 'click',\r\n    element: buttonRef as React.RefObject<Element>,\r\n    options: {\r\n      passive: true,\r\n    },\r\n  });\r\n\r\n  const Button = ({ children, isLoading, ...props }: CreditCardPayButtonProps) => {\r\n    const id = 'rswp-card-button';\r\n    const disabled = isLoading || !card || isSubmitting;\r\n\r\n    return (\r\n      <PayButton\r\n        {...props}\r\n        aria-disabled={disabled}\r\n        css={props?.css}\r\n        disabled={disabled}\r\n        id={id}\r\n        ref={buttonRef}\r\n        type=\"button\"\r\n      >\r\n        {children ?? 'Pay'}\r\n      </PayButton>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <div {...props} data-testid=\"rswps-card-container\" id={id} style={{ minHeight: 89 }}>\r\n        {!card && <LoadingCard />}\r\n      </div>\r\n\r\n      {typeof render === 'function' ? render(Button) : <Button {...buttonProps}>{children ?? 'Pay'}</Button>}\r\n    </>\r\n  );\r\n}\r\n\r\nexport default CreditCard;\r\nexport * from './credit-card.types';\r\n"],"names":["CreditCard","buttonProps","callbacks","children","focus","id","includeInputLabels","postalCode","recalculateSize","render","style","props","card","setCard","React","isSubmitting","setIsSubmitting","buttonRef","cardTokenizeResponseReceived","payments","useForm","options","baseOptions","acc","key","handlePayment","e","result","message","error","abortController","signal","res","callback","useEventListener","Button","isLoading","disabled","PayButton","LoadingCard"],"mappings":"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"}