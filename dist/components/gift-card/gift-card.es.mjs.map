{"version":3,"file":"gift-card.es.mjs","sources":["../../../src/components/gift-card/gift-card.tsx"],"sourcesContent":["// Dependencies\r\nimport { useState, useRef, useMemo, useEffect, JSX } from 'react';\r\nimport type * as Square from '@square/web-sdk';\r\n\r\n// Internals\r\nimport { useForm } from '~/contexts/form';\r\nimport { useEventListener } from '~/hooks/use-event-listener';\r\nimport { LoadingCard, PayButton } from './gift-card.styles';\r\nimport type {\r\n  GiftCardBase,\r\n  GiftCardFunctionChildren,\r\n  GiftCardPayButtonProps,\r\n  GiftCardProps,\r\n  GiftCardWithChildren,\r\n} from './gift-card.types';\r\nimport React from 'react';\r\n\r\n/**\r\n * Renders a Gift Card Input to use in the Square Web Payment SDK, pre-styled to\r\n * meet Square branding guidelines.\r\n *\r\n * **_But with the option to override styles_**\r\n *\r\n * @example\r\n *\r\n * ```tsx\r\n * function App() {\r\n *   return (\r\n *     <SquareForm {...props}>\r\n *       <GiftCard />\r\n *     </SquareForm>\r\n *   );\r\n * }\r\n * ```\r\n */\r\nfunction GiftCard(props: GiftCardBase): JSX.Element;\r\nfunction GiftCard(props: GiftCardFunctionChildren): JSX.Element;\r\nfunction GiftCard(props: GiftCardWithChildren): JSX.Element;\r\nfunction GiftCard({\r\n  buttonProps = {\r\n    id: 'rswps-gift-card-button',\r\n  },\r\n  callbacks,\r\n  children,\r\n  focus,\r\n  id = 'rswps-gift-card-container',\r\n  includeInputLabels,\r\n  render,\r\n  style,\r\n  ...props\r\n}: GiftCardProps) {\r\n  const [giftCard, setGiftCard] = useState<Square.GiftCard | undefined>(() => undefined);\r\n  const [isSubmitting, setIsSubmitting] = useState<boolean>(false);\r\n  const { cardTokenizeResponseReceived, payments } = useForm();\r\n  const buttonRef = useRef<HTMLButtonElement>(null);\r\n\r\n  const options: Square.GiftCardOptions = useMemo(() => {\r\n    const baseOptions = {\r\n      includeInputLabels,\r\n      style,\r\n    };\r\n\r\n    // if a value from options is undefined delete it from the options object\r\n    return Object.keys(baseOptions).reduce((acc: Record<string, unknown>, key) => {\r\n      if (baseOptions[key as keyof typeof baseOptions] !== undefined) {\r\n        acc[key as string] = baseOptions[key as keyof typeof baseOptions];\r\n      }\r\n\r\n      return acc;\r\n    }, {});\r\n  }, [includeInputLabels, style]);\r\n\r\n  /** Tokenizes a GiftCard payment method instance. */\r\n  const handlePayment = async (e: Event) => {\r\n    e.stopPropagation();\r\n\r\n    if (!giftCard) {\r\n      console.warn('Gift Card button was clicked, but no Gift Card instance was found.');\r\n\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n\r\n    try {\r\n      const result = await giftCard?.tokenize();\r\n\r\n      if (result.status === 'OK') {\r\n        const tokenizedResult = await cardTokenizeResponseReceived(result);\r\n        return tokenizedResult;\r\n      }\r\n\r\n      let message = `Tokenization failed with status: ${result.status}`;\r\n      if (result?.errors) {\r\n        message += ` and errors: ${JSON.stringify(result?.errors)}`;\r\n\r\n        throw new Error(message);\r\n      }\r\n\r\n      console.warn(message);\r\n    } catch (error) {\r\n      console.error(error);\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    const abortController = new AbortController();\r\n    const { signal } = abortController;\r\n\r\n    const start = async (signal: AbortSignal) => {\r\n      const giftCard = await payments?.giftCard(options).then((res) => {\r\n        if (!signal.aborted) {\r\n          setGiftCard(res);\r\n\r\n          return res;\r\n        }\r\n\r\n        return null;\r\n      });\r\n\r\n      await giftCard?.attach(`#${id}`);\r\n      if (focus) {\r\n        await giftCard?.focus(focus);\r\n      }\r\n\r\n      if (signal.aborted) {\r\n        await giftCard?.destroy();\r\n      }\r\n    };\r\n\r\n    start(signal);\r\n\r\n    return () => {\r\n      abortController.abort();\r\n    };\r\n  }, [payments, id]);\r\n\r\n  if (callbacks) {\r\n    for (const callback of Object.keys(callbacks)) {\r\n      giftCard?.addEventListener(\r\n        callback as Square.GiftCardInputEventTypes,\r\n        (callbacks as Record<string, (event: Square.SqEvent<Square.GiftCardInputEvent>) => void>)[callback]\r\n      );\r\n    }\r\n  }\r\n\r\n  useEventListener({\r\n    listener: handlePayment,\r\n    type: 'click',\r\n    element: buttonRef.current,\r\n    options: {\r\n      passive: true,\r\n    },\r\n  });\r\n\r\n  const Button = ({ isLoading, ...props }: GiftCardPayButtonProps) => {\r\n    const id = 'rswp-gift-card-button';\r\n    const disabled = isLoading || !giftCard || isSubmitting;\r\n\r\n    return (\r\n      <PayButton\r\n        {...props}\r\n        aria-disabled={disabled}\r\n        css={props?.css}\r\n        disabled={disabled}\r\n        id={id}\r\n        ref={buttonRef}\r\n        type=\"button\"\r\n      >\r\n        {props?.children ?? 'Pay with Gift Card'}\r\n      </PayButton>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <div {...props} data-testid=\"rswps-gift-card-container\" id={id} style={{ minHeight: 89 }}>\r\n        {!giftCard && <LoadingCard />}\r\n      </div>\r\n\r\n      {typeof render === 'function' ? (\r\n        render(Button)\r\n      ) : (\r\n        <Button {...buttonProps}>{children ?? 'Pay with Gift Card'}</Button>\r\n      )}\r\n    </>\r\n  );\r\n}\r\n\r\nexport default GiftCard;\r\nexport * from './gift-card.types';\r\n"],"names":["GiftCard","buttonProps","callbacks","children","focus","id","includeInputLabels","render","style","props","giftCard","setGiftCard","useState","isSubmitting","setIsSubmitting","cardTokenizeResponseReceived","payments","useForm","buttonRef","useRef","options","useMemo","baseOptions","acc","key","handlePayment","result","message","error","useEffect","abortController","signal","res","callback","useEventListener","Button","isLoading","disabled","React","PayButton","LoadingCard"],"mappings":"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"}