{"version":3,"file":"form.cjs.js","sources":["../../../src/contexts/form/form.tsx"],"sourcesContent":["// Dependencies\r\nimport { createContext, useState, useEffect, useContext } from 'react';\r\nimport { payments } from '@square/web-sdk';\r\nimport type * as Square from '@square/web-sdk';\r\n\r\n// Internals\r\nimport { ErrorScreen } from '~/components/error-screen';\r\nimport { useDynamicCallback } from '~/hooks/use-dynamic-callback';\r\nimport type { FormContextType, FormProviderProps } from './form.types';\r\nimport React from 'react';\r\n\r\n/**\r\n * Internal helper that the `PaymentForm` uses to manage internal state and\r\n * expose access to the Web Payment SDK library.\r\n */\r\nconst FormContext = createContext<FormContextType>({\r\n  cardTokenizeResponseReceived: null as unknown as () => Promise<void>,\r\n  createPaymentRequest: null as unknown as Square.PaymentRequestOptions,\r\n  payments: null as unknown as Square.Payments,\r\n});\r\n\r\nfunction FormProvider({ applicationId, locationId, children, overrides, ...props }: FormProviderProps) {\r\n  const [instance, setInstance] = useState<Square.Payments>();\r\n  const [createPaymentRequest] = useState<undefined | Square.PaymentRequestOptions>(() =>\r\n    props.createPaymentRequest?.()\r\n  );\r\n\r\n  useEffect(() => {\r\n    const abortController = new AbortController();\r\n    const { signal } = abortController;\r\n\r\n    async function loadPayment(signal?: AbortSignal): Promise<void> {\r\n      await payments(applicationId, locationId, overrides).then((res) => {\r\n        if (res === null) {\r\n          throw new Error('Square Web Payments SDK failed to load');\r\n        }\r\n\r\n        if (signal?.aborted) {\r\n          return;\r\n        }\r\n\r\n        setInstance(res);\r\n\r\n        return res;\r\n      });\r\n    }\r\n\r\n    if (applicationId && locationId) {\r\n      loadPayment(signal);\r\n    }\r\n\r\n    return () => {\r\n      abortController.abort();\r\n    };\r\n  }, [applicationId, locationId]);\r\n\r\n  const cardTokenizeResponseReceived = async (rest: Square.TokenResult): Promise<void> => {\r\n    if (rest.errors || !props.createVerificationDetails) {\r\n      await props.cardTokenizeResponseReceived(rest);\r\n      return;\r\n    }\r\n\r\n    const verifyBuyerResults = await instance?.verifyBuyer(String(rest.token), props.createVerificationDetails());\r\n\r\n    await props.cardTokenizeResponseReceived(rest, verifyBuyerResults);\r\n  };\r\n\r\n  // Fixes stale closure issue with using React Hooks & SqPaymentForm callback functions\r\n  // https://github.com/facebook/react/issues/16956\r\n  const cardTokenizeResponseReceivedCallback = useDynamicCallback(cardTokenizeResponseReceived);\r\n\r\n  if (!applicationId || !locationId) {\r\n    return <ErrorScreen />;\r\n  }\r\n\r\n  if (!instance) return null;\r\n\r\n  const context: FormContextType = {\r\n    cardTokenizeResponseReceived: cardTokenizeResponseReceivedCallback,\r\n    createPaymentRequest,\r\n    payments: instance,\r\n  };\r\n\r\n  return <FormContext.Provider value={context}>{children}</FormContext.Provider>;\r\n}\r\n\r\nconst useForm = (): FormContextType => {\r\n  const context = useContext(FormContext);\r\n\r\n  if (context === undefined) {\r\n    throw new Error('useForm must be used within a FormProvider');\r\n  }\r\n\r\n  return context;\r\n};\r\n\r\nexport { FormContext, useForm };\r\nexport default FormProvider;\r\n"],"names":["FormContext","createContext","FormProvider","applicationId","locationId","children","overrides","props","instance","setInstance","useState","createPaymentRequest","useEffect","abortController","signal","loadPayment","payments","res","cardTokenizeResponseReceived","rest","verifyBuyerResults","cardTokenizeResponseReceivedCallback","useDynamicCallback","ErrorScreen","context","useForm","useContext"],"mappings":"2TAeMA,EAAcC,EAAAA,cAA+B,CACjD,6BAA8B,KAC9B,qBAAsB,KACtB,SAAU,IACZ,CAAC,EAED,SAASC,EAAa,CAAE,cAAAC,EAAe,WAAAC,EAAY,SAAAC,EAAU,UAAAC,EAAW,GAAGC,GAA4B,CACrG,KAAM,CAACC,EAAUC,CAAW,EAAIC,WAA0B,EACpD,CAACC,CAAoB,EAAID,EAAA,SAAmD,IAChFH,EAAM,uBAAuB,CAC/B,EAEAK,EAAAA,UAAU,IAAM,CACR,MAAAC,EAAkB,IAAI,gBACtB,CAAE,OAAAC,GAAWD,EAEnB,eAAeE,EAAYD,EAAqC,CAC9D,MAAME,EAAAA,SAASb,EAAeC,EAAYE,CAAS,EAAE,KAAMW,GAAQ,CACjE,GAAIA,IAAQ,KACJ,MAAA,IAAI,MAAM,wCAAwC,EAG1D,GAAIH,CAAAA,GAAQ,QAIZ,OAAAL,EAAYQ,CAAG,EAERA,CAAA,CACR,CAAA,CAGH,OAAId,GAAiBC,GACnBW,EAAYD,CAAM,EAGb,IAAM,CACXD,EAAgB,MAAM,CACxB,CAAA,EACC,CAACV,EAAeC,CAAU,CAAC,EAExB,MAAAc,EAA+B,MAAOC,GAA4C,CACtF,GAAIA,EAAK,QAAU,CAACZ,EAAM,0BAA2B,CAC7C,MAAAA,EAAM,6BAA6BY,CAAI,EAC7C,MAAA,CAGI,MAAAC,EAAqB,MAAMZ,GAAU,YAAY,OAAOW,EAAK,KAAK,EAAGZ,EAAM,2BAA2B,EAEtG,MAAAA,EAAM,6BAA6BY,EAAMC,CAAkB,CACnE,EAIMC,EAAuCC,qBAAmBJ,CAA4B,EAExF,GAAA,CAACf,GAAiB,CAACC,EACrB,uBAAQmB,EAAY,QAAA,IAAA,EAGlB,GAAA,CAACf,EAAiB,OAAA,KAEtB,MAAMgB,EAA2B,CAC/B,6BAA8BH,EAC9B,qBAAAV,EACA,SAAUH,CACZ,EAEA,uBAAQR,EAAY,SAAZ,CAAqB,MAAOwB,GAAUnB,CAAS,CACzD,CAEA,MAAMoB,EAAU,IAAuB,CAC/B,MAAAD,EAAUE,aAAW1B,CAAW,EAEtC,GAAIwB,IAAY,OACR,MAAA,IAAI,MAAM,4CAA4C,EAGvD,OAAAA,CACT"}