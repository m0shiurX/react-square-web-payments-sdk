{"version":3,"file":"form.es.mjs","sources":["../../../src/contexts/form/form.tsx"],"sourcesContent":["// Dependencies\r\nimport { createContext, useState, useEffect, useContext } from 'react';\r\nimport { payments } from '@square/web-sdk';\r\nimport type * as Square from '@square/web-sdk';\r\n\r\n// Internals\r\nimport { ErrorScreen } from '~/components/error-screen';\r\nimport { useDynamicCallback } from '~/hooks/use-dynamic-callback';\r\nimport type { FormContextType, FormProviderProps } from './form.types';\r\nimport React from 'react';\r\n\r\n/**\r\n * Internal helper that the `PaymentForm` uses to manage internal state and\r\n * expose access to the Web Payment SDK library.\r\n */\r\nconst FormContext = createContext<FormContextType>({\r\n  cardTokenizeResponseReceived: null as unknown as () => Promise<void>,\r\n  createPaymentRequest: null as unknown as Square.PaymentRequestOptions,\r\n  payments: null as unknown as Square.Payments,\r\n});\r\n\r\nfunction FormProvider({ applicationId, locationId, children, overrides, ...props }: FormProviderProps) {\r\n  const [instance, setInstance] = useState<Square.Payments>();\r\n  const [createPaymentRequest] = useState<undefined | Square.PaymentRequestOptions>(() =>\r\n    props.createPaymentRequest?.()\r\n  );\r\n\r\n  useEffect(() => {\r\n    const abortController = new AbortController();\r\n    const { signal } = abortController;\r\n\r\n    async function loadPayment(signal?: AbortSignal): Promise<void> {\r\n      await payments(applicationId, locationId, overrides).then((res) => {\r\n        if (res === null) {\r\n          throw new Error('Square Web Payments SDK failed to load');\r\n        }\r\n\r\n        if (signal?.aborted) {\r\n          return;\r\n        }\r\n\r\n        setInstance(res);\r\n\r\n        return res;\r\n      });\r\n    }\r\n\r\n    if (applicationId && locationId) {\r\n      loadPayment(signal);\r\n    }\r\n\r\n    return () => {\r\n      abortController.abort();\r\n    };\r\n  }, [applicationId, locationId]);\r\n\r\n  const cardTokenizeResponseReceived = async (rest: Square.TokenResult): Promise<void> => {\r\n    if (rest.errors || !props.createVerificationDetails) {\r\n      await props.cardTokenizeResponseReceived(rest);\r\n      return;\r\n    }\r\n\r\n    const verifyBuyerResults = await instance?.verifyBuyer(String(rest.token), props.createVerificationDetails());\r\n\r\n    await props.cardTokenizeResponseReceived(rest, verifyBuyerResults);\r\n  };\r\n\r\n  // Fixes stale closure issue with using React Hooks & SqPaymentForm callback functions\r\n  // https://github.com/facebook/react/issues/16956\r\n  const cardTokenizeResponseReceivedCallback = useDynamicCallback(cardTokenizeResponseReceived);\r\n\r\n  if (!applicationId || !locationId) {\r\n    return <ErrorScreen />;\r\n  }\r\n\r\n  if (!instance) return null;\r\n\r\n  const context: FormContextType = {\r\n    cardTokenizeResponseReceived: cardTokenizeResponseReceivedCallback,\r\n    createPaymentRequest,\r\n    payments: instance,\r\n  };\r\n\r\n  return <FormContext.Provider value={context}>{children}</FormContext.Provider>;\r\n}\r\n\r\nconst useForm = (): FormContextType => {\r\n  const context = useContext(FormContext);\r\n\r\n  if (context === undefined) {\r\n    throw new Error('useForm must be used within a FormProvider');\r\n  }\r\n\r\n  return context;\r\n};\r\n\r\nexport { FormContext, useForm };\r\nexport default FormProvider;\r\n"],"names":["FormContext","createContext","FormProvider","applicationId","locationId","children","overrides","props","instance","setInstance","useState","createPaymentRequest","useEffect","abortController","signal","loadPayment","payments","res","cardTokenizeResponseReceivedCallback","useDynamicCallback","rest","verifyBuyerResults","ErrorScreen","context","useForm","useContext"],"mappings":";;;;AAeA,MAAMA,IAAcC,EAA+B;AAAA,EACjD,8BAA8B;AAAA,EAC9B,sBAAsB;AAAA,EACtB,UAAU;AACZ,CAAC;AAED,SAASC,EAAa,EAAE,eAAAC,GAAe,YAAAC,GAAY,UAAAC,GAAU,WAAAC,GAAW,GAAGC,KAA4B;AACrG,QAAM,CAACC,GAAUC,CAAW,IAAIC,EAA0B,GACpD,CAACC,CAAoB,IAAID;AAAA,IAAmD,MAChFH,EAAM,uBAAuB;AAAA,EAC/B;AAEA,EAAAK,EAAU,MAAM;AACR,UAAAC,IAAkB,IAAI,gBAAgB,GACtC,EAAE,QAAAC,MAAWD;AAEnB,mBAAeE,EAAYD,GAAqC;AAC9D,YAAME,EAASb,GAAeC,GAAYE,CAAS,EAAE,KAAK,CAACW,MAAQ;AACjE,YAAIA,MAAQ;AACJ,gBAAA,IAAI,MAAM,wCAAwC;AAG1D,YAAIH,CAAAA,GAAQ;AAIZ,iBAAAL,EAAYQ,CAAG,GAERA;AAAA,MAAA,CACR;AAAA,IAAA;AAGH,WAAId,KAAiBC,KACnBW,EAAYD,CAAM,GAGb,MAAM;AACX,MAAAD,EAAgB,MAAM;AAAA,IACxB;AAAA,EAAA,GACC,CAACV,GAAeC,CAAU,CAAC;AAexB,QAAAc,IAAuCC,EAbR,OAAOC,MAA4C;AACtF,QAAIA,EAAK,UAAU,CAACb,EAAM,2BAA2B;AAC7C,YAAAA,EAAM,6BAA6Ba,CAAI;AAC7C;AAAA,IAAA;AAGI,UAAAC,IAAqB,MAAMb,GAAU,YAAY,OAAOY,EAAK,KAAK,GAAGb,EAAM,2BAA2B;AAEtG,UAAAA,EAAM,6BAA6Ba,GAAMC,CAAkB;AAAA,EACnE,CAI4F;AAExF,MAAA,CAAClB,KAAiB,CAACC;AACrB,2CAAQkB,GAAY,IAAA;AAGlB,MAAA,CAACd,EAAiB,QAAA;AAEtB,QAAMe,IAA2B;AAAA,IAC/B,8BAA8BL;AAAA,IAC9B,sBAAAP;AAAA,IACA,UAAUH;AAAA,EACZ;AAEA,yCAAQR,EAAY,UAAZ,EAAqB,OAAOuB,KAAUlB,CAAS;AACzD;AAEA,MAAMmB,IAAU,MAAuB;AAC/B,QAAAD,IAAUE,EAAWzB,CAAW;AAEtC,MAAIuB,MAAY;AACR,UAAA,IAAI,MAAM,4CAA4C;AAGvD,SAAAA;AACT;"}